# Developing

## Setting up development environment

You will start by
[forking](https://github.com/GEOLYTIX/xyz/fork) the XYZ repository.

### Development dependencies

The minimum requirements are:

* Git
* [Node.js](https://nodejs.org/) (version 18 and above)

The executables `git` and `node` should be in your `PATH`.

To install the Node.js dependencies run

    npm install

Please check the full list of dependencies as defined in the [package.json](https://github.com/GEOLYTIX/xyz/blob/main/package.json)

## ESBuild

The MAPP and MAPP.UI library must be build with [esbuild](https://esbuild.github.io/) prior to launching the host.

    npx esbuild ./lib/mapp.mjs ./lib/ui.mjs --bundle --minify --tree-shaking=false --sourcemap --format=iife --outdir=./public/js/lib

The build command is stored in the package.json as `_build` script.

    npm run _build

ESBuild must also be used to compile the CSS supporting the MAPP and MAPP.UI elements.

    npx esbuild --bundle public/css/_mapp.css --outfile=public/css/mapp.css

    npx esbuild --bundle public/css/_ui.css --outfile=public/css/ui.css --loader:.svg=dataurl

### Development with VSCode Debugger and Live Reload

We've set up a development environment that includes automatic rebuilding, browser reloading, and VSCode debugging capabilities.

#### Setup

Configure VSCode for debugging:

`.vscode/launch.json`:

```json
{
  "version": "0.2.0",
  "configurations": [
    {
      "type": "node",
        "request": "launch",
        "name": "Launch Server",
        "program": "${workspaceFolder}/express.js",
        "preLaunchTask": "start-watch",
        "console": "integratedTerminal",
        "skipFiles": [
            "<node_internals>/**",
            "node_modules/**"
        ],
        "internalConsoleOptions": "openOnSessionStart",
        "env": {
            "NODE_ENV": "development" //This is to ensure that the bundle isn't minified so we can see variables locally.
        }
    },
    {
        "type": "chrome",
        "request": "launch",
        "name": "Debug in Chrome",
        "url": "http://localhost:3001",
        "webRoot": "${workspaceFolder}/xyz/lib", //Please check your worksapceFolder
        "sourceMaps": true,
        "pauseForSourceMap": true
    }
  ]
}
```

`.vscode/tasks.json`:

```json
{
    "version": "2.0.0",
    "tasks": [
        {
            "label": "start-watch",
            "type": "shell",
            "command": "npx concurrently \"npx nodemon\" \"npm run browser-sync\"",
            "isBackground": true,
            "problemMatcher": {
                "pattern": {
                    "regexp": "^.*$"
                },
                "background": {
                    "activeOnStart": true,
                    "beginsPattern": "Watching for changes...",
                    "endsPattern": "Build complete"
                }
            }
        }
    ]
}
```

#### Usage

1. Open the project in VSCode
2. Launch the server first by executing "Launch Server"
3. Then if you want to debugg chrome directly in vscode run "Debug in Chrome";
4. Access the site at `http://localhost:3001`

This setup provides:

* Automatic rebuilding of files when changes are detected in the `lib`, 'tests' and `public/css' directories
* Automatic browser reload after successful builds
* VSCode debugging capabilities
* Source maps for better debugging experience
* Express server running on port 3000
* Browser-sync proxy on port 3001 with Portal on port 3002

The browser will automatically reload whenever you make changes to files in the `lib`, 'tests' and `public/css' directories. You can set breakpoints in VSCode for debugging both the frontend and backend code.

```

## ESLint

The codebase makes use of the [eslint](eslint.org) package to ensure that our code adhere to different rules and coding guidelines.
To run `eslint` you will need to have the development packages installed. You can ensure they are installed by running `npm install` in the root of the xyz directory.

To run the lint you can execute `npx eslint .` in the root of the application. This will show any issues there are with the codebase. You can also add the flag `--fix` to the command to allow eslint to fix any issues it may find.

eslint command

    npx esbuild .

eslint command with fix

    npx esbuild . --fix

There are other extensions you can use in your editor to get on the fly error highlighting where any rules are broken. Please look into what eslint supports in your environment.

## version.js hash

The mapp module object holds a hash of the latest release commit which can be generated by executing the version.js script in the root.

The version script will complete by executing the ESBuild process.

    node version.js

## Express

[Express.js](https://expressjs.com/) will be installed by npm as a development dependency. You can run a zero config instance by loading the express.js script in your node runtime.

    node express.js

The default port is 3000. You can access the mapp interface on <http://localhost:3000/> in your browser.

Please refer to the [Getting Started](https://github.com/GEOLYTIX/xyz/wiki/Getting-started) wiki page for the next steps in regards to workspace configuration and environment variables.
